<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ åœ£è¯æ‰‹åŠ¿äº’åŠ¨åº†å…¸ ğŸ</title>
    <style>
        /* åŸºç¡€æ ·å¼é‡ç½® */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* é¡µé¢æ•´ä½“æ ·å¼ */
        .christmas-page {
            height: 100vh;
            width: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #0a2e38 0%, #1a1a2e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* è§†é¢‘/Canvas å®¹å™¨ï¼šç”¨äºæ˜¾ç¤ºæ‘„åƒå¤´ç”»é¢å’Œæ‰‹éƒ¨è¿½è¸ª */
        .camera-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            /* è°ƒæ•´ä¸é€æ˜åº¦ï¼Œè®©èƒŒæ™¯è§†é¢‘/æ¸å˜é€å‡ºæ¥ */
            opacity: 0.5; 
        }
        
        /* éšè—åŸå§‹è§†é¢‘ï¼Œæ”¹ç”¨æ‘„åƒå¤´è§†é¢‘ */
        .video-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(0.7);
            z-index: 0; /* ä¿æŒåœ¨æœ€åº•å±‚ */
        }

        /* æ‘„åƒå¤´è§†é¢‘æµå’Œ Canvas è¦†ç›– */
        #webcamVideo, #handCanvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ï¼Œè®©ç”¨æˆ·æ„Ÿè§‰æ›´è‡ªç„¶ */
        }
        
        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            position: relative;
            z-index: 3; /* ç¡®ä¿å†…å®¹åœ¨é›ªèŠ±å’Œæ‘„åƒå¤´ç”»é¢ä¹‹ä¸Š */
            text-align: center;
            color: white;
            padding: 20px;
        }

        /* äº’åŠ¨å…ƒç´ æ ·å¼ */
        #interaction-display {
            font-size: 3rem;
            min-height: 4rem; /* ç¡®ä¿æœ‰è¶³å¤Ÿçš„ç©ºé—´ */
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }

        /* åœ£è¯æ ‘åŠ¨ç”» */
        .tree-animate {
            font-size: 10rem !important;
            color: #4CAF50; /* ç»¿è‰² */
            text-shadow: 0 0 20px rgba(76, 175, 80, 0.8);
            transform: scale(1.1) rotate(5deg);
        }

        /* æ–‡å­—æ ·å¼ */
        .text-animate {
            font-size: 4rem !important;
            font-weight: bold;
            color: #E53935; /* çº¢è‰² */
            text-shadow: 0 0 15px rgba(229, 57, 53, 0.7);
            transform: scale(1.05);
        }
        
        /* é›ªèŠ±æ•ˆæœ (ä¸åŸä»£ç ä¿æŒä¸€è‡´) */
        .snowflake {
            position: absolute;
            color: white;
            font-size: 1.5rem;
            user-select: none;
            z-index: 2; 
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision/vision_bundle.js" crossorigin="anonymous"></script>
</head>

<body>
    <div class="christmas-page">
        
        <video class="video-background" autoplay muted loop playsinline>
            <source src="åœ£è¯å¿«ä¹.mp4" type="video/mp4">
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
        </video>

        <div class="camera-container">
            <video id="webcamVideo" autoplay playsinline style="display: none;"></video>
            <canvas id="handCanvas"></canvas>
        </div>
        
        <div class="main-content">
            <p id="interaction-display">ç­‰å¾…æ‰‹åŠ¿...</p>
            <p id="status-message" style="font-size: 1.2rem; margin-top: 20px;">è¯·æˆæƒæ‘„åƒå¤´æƒé™</p>
        </div>
    </div>
    
    <script>
        // --- I. é›ªèŠ±æ•ˆæœåˆå§‹åŒ– (æ‚¨çš„åŸå§‹ä»£ç ) ---
        function createSnowflakes() {
            const snowflakesContainer = document.createElement('div');
            snowflakesContainer.className = 'snowflakes-container';
            document.querySelector('.christmas-page').appendChild(snowflakesContainer);
            
            const snowflakeSymbols = ['â„', 'â…', 'â†', 'â€¢', '*'];
            
            for (let i = 0; i < 80; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.textContent = snowflakeSymbols[Math.floor(Math.random() * snowflakeSymbols.length)];
                
                snowflake.style.left = Math.random() * 100 + 'vw';
                const size = Math.random() * 1.5 + 0.8;
                snowflake.style.fontSize = size + 'rem';
                snowflake.style.opacity = Math.random() * 0.7 + 0.3;
                
                const duration = Math.random() * 10 + 5;
                snowflake.style.animationDuration = duration + 's';
                snowflake.style.animationDelay = Math.random() * 5 + 's';
                
                snowflakesContainer.appendChild(snowflake);
            }
        }
        
        // --- II. æ‰‹åŠ¿è¯†åˆ«å’Œäº¤äº’é€»è¾‘ ---
        
        const { HandLandmarker, FilesetResolver } = window.MediaPipeTasksVision;
        
        const video = document.getElementById('webcamVideo');
        const canvasElement = document.getElementById('handCanvas');
        const canvasCtx = canvasElement.getContext('2d');
        const interactionDisplay = document.getElementById('interaction-display');
        const statusMessage = document.getElementById('status-message');

        let handLandmarker;
        let lastVideoTime = -1;
        let runningMode = "VIDEO";

        // 1. åŠ è½½æ‰‹éƒ¨æ¨¡å‹
        async function createHandLandmarker() {
            const filesetResolver = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
            );
            handLandmarker = await HandLandmarker.create(filesetResolver, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: runningMode,
                numHands: 1
            });
            statusMessage.textContent = 'æ¨¡å‹åŠ è½½å®Œæˆï¼Œè¯·æˆäºˆæ‘„åƒå¤´æƒé™...';
            enableCam();
        }

        // 2. å¯ç”¨æ‘„åƒå¤´
        function enableCam() {
            if (!handLandmarker) {
                statusMessage.textContent = "æ‰‹éƒ¨æ¨¡å‹å°šæœªåŠ è½½ã€‚";
                return;
            }

            // è·å–æ‘„åƒå¤´æƒé™
            navigator.mediaDevices.getUserMedia({ video: true })
                .then((stream) => {
                    video.srcObject = stream;
                    video.addEventListener("loadeddata", predictWebcam);
                    statusMessage.textContent = 'æ‘„åƒå¤´å·²å¯åŠ¨ã€‚';
                    // ç¡®ä¿ Canvas å°ºå¯¸åŒ¹é…è§†é¢‘
                    video.onloadedmetadata = () => {
                        canvasElement.width = video.videoWidth;
                        canvasElement.height = video.videoHeight;
                    };
                })
                .catch((err) => {
                    statusMessage.textContent = `æ— æ³•è®¿é—®æ‘„åƒå¤´: ${err.message}.`;
                });
        }

        // 3. å®æ—¶é¢„æµ‹
        function predictWebcam() {
            let startTimeMs = performance.now();
            let results;

            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                results = handLandmarker.detectForVideo(video, lastVideoTime);
            }

            // ç»˜åˆ¶æ‰‹éƒ¨æ ‡è®° (å¯é€‰)
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.landmarks && results.landmarks.length > 0) {
                // MediaPipe æä¾›çš„ç»˜åˆ¶å‡½æ•°
                // for (const landmarks of results.landmarks) {
                //     drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: "#00FF00", lineWidth: 5 });
                //     drawLandmarks(canvasCtx, landmarks, { color: "#FF0000", lineWidth: 2 });
                // }
                
                // ä»…æ£€æµ‹æ‰‹åŠ¿
                const handLandmarks = results.landmarks[0];
                const gesture = recognizeGesture(handLandmarks);
                
                handleGestureInteraction(gesture);

            } else {
                // æœªæ£€æµ‹åˆ°æ‰‹
                handleGestureInteraction(null);
            }

            canvasCtx.restore();

            // æŒç»­è°ƒç”¨é¢„æµ‹
            window.requestAnimationFrame(predictWebcam);
        }

        // 4. ç®€å•æ‰‹åŠ¿è¯†åˆ«é€»è¾‘
        function recognizeGesture(landmarks) {
            // ä½¿ç”¨æ‰‹æŒ‡å°–çš„Yåæ ‡æ¥åˆ¤æ–­æ˜¯å¦å¼¯æ›²
            // æ‹‡æŒ‡å°– (4), é£ŸæŒ‡å°– (8), ä¸­æŒ‡å°– (12), æ— åæŒ‡å°– (16), å°æŒ‡å°– (20)
            
            const fingerTips = [8, 12, 16, 20]; // é£ŸæŒ‡åˆ°å°æŒ‡çš„æŒ‡å°–
            const metacarpals = [5, 9, 13, 17]; // å¯¹åº”çš„æŒ‡æ ¹
            const thumbTip = landmarks[4];
            const thumbBase = landmarks[2];

            let fingersExtended = 0;
            
            // æ£€æŸ¥é£ŸæŒ‡åˆ°å°æŒ‡æ˜¯å¦ä¼¸ç›´ï¼ˆæŒ‡å°–Yåæ ‡é«˜äºæˆ–æ¥è¿‘æŒ‡æ ¹Yåæ ‡ï¼‰
            for (let i = 0; i < fingerTips.length; i++) {
                const tipY = landmarks[fingerTips[i]].y;
                const metacarpalY = landmarks[metacarpals[i]].y;
                // é˜ˆå€¼åˆ¤æ–­ï¼šå¦‚æœæŒ‡å°–Yåæ ‡æ˜¾è‘—ä½äºæŒ‡æ ¹Yåæ ‡ï¼Œåˆ™è®¤ä¸ºæ˜¯å¼¯æ›²/æ¡æ‹³
                if (tipY < metacarpalY - 0.05) { // ä¼¸ç›´
                    fingersExtended++;
                }
            }

            // æ£€æŸ¥æ‹‡æŒ‡æ˜¯å¦ä¼¸ç›´ï¼ˆæ‹‡æŒ‡å°–Xåæ ‡åœ¨æ‹‡æŒ‡æ ¹éƒ¨Xåæ ‡çš„ä¸€ä¾§ï¼‰
            // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„æ£€æŸ¥ï¼Œé€šå¸¸éœ€è¦æ›´å¤šå‡ ä½•åˆ¤æ–­
            const thumbExtended = Math.abs(thumbTip.x - thumbBase.x) > 0.05; 
            if (thumbExtended) {
                 // æ‹‡æŒ‡ä¼¸ç›´åˆ¤æ–­
            }

            // æ¡æ‹³ (Closed Fist): å¤§éƒ¨åˆ†æ‰‹æŒ‡æ²¡æœ‰ä¼¸ç›´ (å°äº 2 ä¸ªä¼¸ç›´)
            if (fingersExtended < 2) {
                return 'CLOSED_FIST';
            } 
            
            // å¼ å¼€æ‰‹æŒ (Open Palm): å¤§éƒ¨åˆ†æ‰‹æŒ‡ä¼¸ç›´ (4 ä¸ªæˆ–æ›´å¤šä¼¸ç›´)
            if (fingersExtended >= 4) {
                return 'OPEN_PALM';
            }
            
            return 'UNKNOWN'; // æ— æ³•è¯†åˆ«
        }

        // 5. å¤„ç†æ‰‹åŠ¿ä¸é¡µé¢äº¤äº’
        function handleGestureInteraction(gesture) {
            interactionDisplay.style.opacity = '1';
            interactionDisplay.className = ''; // é‡ç½®åŠ¨ç”»ç±»
            
            if (gesture === 'OPEN_PALM') {
                interactionDisplay.textContent = 'ğŸ„';
                interactionDisplay.classList.add('tree-animate');
                statusMessage.textContent = 'æ‰‹æŒæ‰“å¼€ï¼šåœ£è¯æ ‘å‡ºç°ï¼';
            } else if (gesture === 'CLOSED_FIST') {
                interactionDisplay.textContent = 'åœ£è¯å¿«ä¹';
                interactionDisplay.classList.add('text-animate');
                statusMessage.textContent = 'æ¡æ‹³ï¼šåœ£è¯å¿«ä¹ï¼';
            } else {
                // æ²¡æœ‰è¯†åˆ«åˆ°æ‰‹åŠ¿æˆ–æ‰‹åŠ¿ä¸æ¸…
                interactionDisplay.textContent = 'ç­‰å¾…æ‰‹åŠ¿...';
                interactionDisplay.style.opacity = '0.5';
                statusMessage.textContent = 'æ­£åœ¨ç­‰å¾…æ‰‹åŠ¿ï¼ˆå¼ å¼€æ‰‹æŒ/æ¡æ‹³ï¼‰...';
            }
        }
        
        // --- III. åˆå§‹åŒ–é¡µé¢ ---
        document.addEventListener('DOMContentLoaded', function() {
            createSnowflakes(); // å¯åŠ¨é›ªèŠ±
            createHandLandmarker(); // å¯åŠ¨æ‰‹åŠ¿è¯†åˆ«
        });
    </script>
</body>
</html>
