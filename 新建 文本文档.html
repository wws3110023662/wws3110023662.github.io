<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç²’å­è¡¨ç™½ç³»ç»Ÿ - ç¨³å®šäº¤äº’ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Microsoft YaHei', sans-serif; }
        
        /* çŠ¶æ€æ˜¾ç¤º HUD */
        #hud-panel {
            position: absolute; top: 20px; left: 20px; 
            background: rgba(0, 0, 0, 0.6); padding: 15px; border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #00ffff; pointer-events: none; user-select: none;
            z-index: 10; width: 220px;
        }
        #hud-status { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        #hud-detail { font-size: 12px; color: #aaa; line-height: 1.5; }

        /* è¾“å…¥é¢æ¿ */
        #input-panel {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(20, 20, 30, 0.9); padding: 20px; border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; width: 280px; z-index: 10;
            transition: opacity 0.3s; opacity: 0.3;
        }
        #input-panel:hover { opacity: 1; }
        input {
            width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px;
            border: 1px solid #444; background: rgba(0,0,0,0.5); color: white;
            box-sizing: border-box;
        }
        label { font-size: 12px; color: #aaa; display: block; margin-bottom: 5px; }
        
        /* éšè—çš„æ‘„åƒå¤´è§†é¢‘ */
        #video-feed { position: absolute; top: 0; left: 0; opacity: 0; z-index: -1; pointer-events: none; }
        
        /* åŠ è½½é®ç½© */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: #00ffff; z-index: 999;
            transition: opacity 0.5s;
        }
    </style>
    
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="loader">
        <h2>ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</h2>
        <p>æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´ä¸ AI æ¨¡å‹</p>
        <p style="font-size:12px; color:#666">è¯·ç¡®ä¿ä½¿ç”¨ https æˆ– localhost è®¿é—®</p>
    </div>

    <div id="hud-panel">
        <div id="hud-status">ç­‰å¾…æ‰‹åŠ¿...</div>
        <div id="hud-detail">
            ğŸ‘† å•æŒ‡ï¼šç¬¬ä¸€ä¸ªå­—<br>
            âœŒï¸ åŒæŒ‡ï¼šç¬¬äºŒä¸ªå­—<br>
            ğŸ¤Ÿ ä¸‰æŒ‡ï¼šç¬¬ä¸‰ä¸ªå­—<br>
            ğŸ– å¼ æ‰‹ï¼šå˜çˆ±å¿ƒ<br>
            âœŠ æ¡æ‹³ï¼šçˆ†ç‚¸è¡¨ç™½
        </div>
    </div>

    <div id="input-panel">
        <label>åå­—</label>
        <input type="text" id="input-name" value="ç‹æ ‡">
        <label>è¡¨ç™½å†…å®¹</label>
        <input type="text" id="input-msg" value="æˆ‘æ°¸è¿œçˆ±ä½ ">
        <div style="font-size:10px; color:#666; margin-top:5px;">* é¼ æ ‡æ‚¬åœå¯ä¿®æ”¹å†…å®¹</div>
    </div>

    <video id="video-feed" playsinline></video>

<script>
    // --- æ ¸å¿ƒé…ç½® ---
    const PARTICLE_COUNT = 30000; 
    const PARTICLE_SIZE = 0.18;

    // --- å…¨å±€å˜é‡ ---
    let scene, camera, renderer, particles;
    let particlePositions, colors, targetPositions;
    let geometry;
    
    // çŠ¶æ€æ§åˆ¶
    let isExploding = false;
    let explosionVelocities = [];
    let isTextState = false; // æ§åˆ¶æ˜¯å¦éœ€è¦æ™ºèƒ½å›æ­£

    // ç”»å¸ƒç›¸å…³
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // æ‰‹åŠ¿çŠ¶æ€æœº
    let lastGesture = 'none';
    let gestureFrameCount = 0;
    const GESTURE_THRESHOLD = 10; 

    // å¯åŠ¨å…¥å£
    initThree();
    initMediaPipe();
    animate();

    // =========================================================
    // 1. THREE.JS ç²’å­ç³»ç»Ÿéƒ¨åˆ†
    // =========================================================
    function initThree() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        scene.fog = new THREE.FogExp2(0x050505, 0.02);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 35;

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        initParticles();
        calculateSpherePositions(); 
        window.addEventListener('resize', onWindowResize);
    }

    function initParticles() {
        geometry = new THREE.BufferGeometry();
        particlePositions = new Float32Array(PARTICLE_COUNT * 3);
        colors = new Float32Array(PARTICLE_COUNT * 3);
        targetPositions = new Float32Array(PARTICLE_COUNT * 3);

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            particlePositions[i*3] = (Math.random()-0.5)*50;
            particlePositions[i*3+1] = (Math.random()-0.5)*50;
            particlePositions[i*3+2] = (Math.random()-0.5)*50;
            colors[i*3] = 0; colors[i*3+1] = 0.8; colors[i*3+2] = 1;
            explosionVelocities.push({x:0, y:0, z:0});
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

        const material = new THREE.PointsMaterial({
            size: PARTICLE_SIZE,
            vertexColors: true,
            blending: THREE.AdditiveBlending,
            depthWrite: false,
            transparent: true,
            opacity: 0.8
        });

        particles = new THREE.Points(geometry, material);
        scene.add(particles);
    }

    function getTextPositions(textStr, fontSize = 100) {
        ctx.font = `bold ${fontSize}px "Microsoft YaHei"`;
        const textWidth = Math.ceil(ctx.measureText(textStr).width);
        
        const dynamicWidth = textWidth + 60; 
        const dynamicHeight = Math.max(fontSize * 1.5, 200);
        
        canvas.width = dynamicWidth;
        canvas.height = dynamicHeight;

        ctx.clearRect(0, 0, dynamicWidth, dynamicHeight);
        ctx.fillStyle = 'white';
        ctx.font = `bold ${fontSize}px "Microsoft YaHei"`; 
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(textStr, dynamicWidth / 2, dynamicHeight / 2);

        const data = ctx.getImageData(0, 0, dynamicWidth, dynamicHeight).data;
        const validPositions = [];

        for (let y = 0; y < dynamicHeight; y += 2) { 
            for (let x = 0; x < dynamicWidth; x += 2) {
                if (data[(y * dynamicWidth + x) * 4 + 3] > 128) {
                    const posX = (x - dynamicWidth / 2) * 0.15; 
                    const posY = -(y - dynamicHeight / 2) * 0.15; 
                   
