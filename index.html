<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç²’å­è¡¨ç™½ç³»ç»Ÿ - æ‰‹åŠ¿æ§åˆ¶</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Microsoft YaHei', sans-serif; }
        
        /* çŠ¶æ€æ˜¾ç¤º HUD */
        #hud-panel {
            position: absolute; top: 20px; left: 20px; 
            background: rgba(0, 0, 0, 0.6); padding: 15px; border-radius: 8px;
            border: 1px solid rgba(0, 255, 255, 0.3);
            color: #00ffff; pointer-events: none; user-select: none;
            z-index: 10; width: 220px;
        }
        #hud-status { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
        #hud-detail { font-size: 12px; color: #aaa; line-height: 1.5; }

        /* è¾“å…¥é¢æ¿ */
        #input-panel {
            position: absolute; bottom: 20px; left: 20px;
            background: rgba(20, 20, 30, 0.9); padding: 20px; border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white; width: 280px; z-index: 10;
            transition: opacity 0.3s; opacity: 0.3;
        }
        #input-panel:hover { opacity: 1; }
        input {
            width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px;
            border: 1px solid #444; background: rgba(0,0,0,0.5); color: white;
            box-sizing: border-box;
        }
        label { font-size: 12px; color: #aaa; display: block; margin-bottom: 5px; }
        
        /* éšè—çš„æ‘„åƒå¤´è§†é¢‘ */
        #video-feed { position: absolute; top: 0; left: 0; opacity: 0; z-index: -1; pointer-events: none; }
        
        /* åŠ è½½é®ç½© */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: #00ffff; z-index: 999;
            transition: opacity 0.5s;
        }
        
        /* æ¨±èŠ±é›¨ */
        .petal {
            position: absolute;
            background-color: #f8c8f2;
            border-radius: 50%;
            animation: fall 3s linear infinite;
        }
        @keyframes fall {
            0% { top: -10px; opacity: 1; }
            100% { top: 100vh; opacity: 0; }
        }

        /* èŠ±ç“£é›¨ */
        .flower-petal {
            position: absolute;
            background-color: #ff80bf;
            border-radius: 50%;
            animation: flowerFall 3s linear infinite;
        }
        @keyframes flowerFall {
            0% { top: -10px; opacity: 1; }
            100% { top: 100vh; opacity: 0; }
        }
        
        /* æ–‡å­—æ˜¾ç¤º */
        #message {
            position: absolute;
            color: #ffffff;
            font-size: 48px;
            text-align: center;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            opacity: 0;
            transition: opacity 1s;
        }
    </style>
    
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="loader">
        <h2>ç³»ç»Ÿåˆå§‹åŒ–ä¸­...</h2>
        <p>æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´ä¸ AI æ¨¡å‹</p>
        <p style="font-size:12px; color:#666">è¯·ç¡®ä¿ä½¿ç”¨ https æˆ– localhost è®¿é—®</p>
    </div>

    <div id="hud-panel">
        <div id="hud-status">ç­‰å¾…æ‰‹åŠ¿...</div>
        <div id="hud-detail">
            ğŸ‘† å•æŒ‡ï¼šå¼€å¼€å¿ƒå¿ƒ<br>
            âœŒï¸ åŒæŒ‡ï¼šå¥½å¥½çˆ±è‡ªå·±<br>
            ğŸ¤Ÿ ä¸‰æŒ‡ï¼šä»Šå¤©å¾ˆå“‡å¡<br>
            ğŸ– å¼ æ‰‹ï¼šå˜çˆ±å¿ƒ<br>
            âœŠ æ¡æ‹³ï¼šæˆ‘çœŸçš„å¾ˆæ£’
        </div>
    </div>

    <div id="input-panel">
        <label>åå­—</label>
        <input type="text" id="input-name" value="ç‹æ ‡">
        <label>è¡¨ç™½å†…å®¹</label>
        <input type="text" id="input-msg" value="æˆ‘æ°¸è¿œçˆ±ä½ ">
        <div style="font-size:10px; color:#666; margin-top:5px;">* é¼ æ ‡æ‚¬åœå¯ä¿®æ”¹å†…å®¹</div>
    </div>

    <video id="video-feed" playsinline></video>
    <div id="message"></div>

<script>
    // --- æ ¸å¿ƒé…ç½® ---
    const PARTICLE_COUNT = 30000; 
    const PARTICLE_SIZE = 0.18;

    // --- å…¨å±€å˜é‡ ---
    let scene, camera, renderer, particles;
    let particlePositions, colors, targetPositions;
    let geometry;
    
    // çŠ¶æ€æ§åˆ¶
    let isExploding = false;
    let explosionVelocities = [];
    let isTextState = false; // æ§åˆ¶æ˜¯å¦éœ€è¦æ™ºèƒ½å›æ­£

    // ç”»å¸ƒç›¸å…³
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // æ‰‹åŠ¿çŠ¶æ€æœº
    let lastGesture = 'none';
    let gestureFrameCount = 0;
    const GESTURE_THRESHOLD = 10; 

    // å¯åŠ¨å…¥å£
    initThree();
    initMediaPipe();
    animate();

    // =========================================================
    // 1. THREE.JS ç²’å­ç³»ç»Ÿéƒ¨åˆ†
    // =========================================================
    function initThree() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        scene.fog = new THREE.FogExp2(0x050505, 0.02);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 35;

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.body.appendChild(renderer.domElement);

        initParticles();
        calculateSpherePositions(); 
        window.addEventListener('resize', onWindowResize);
    }

    function initParticles() {
        geometry = new THREE.BufferGeometry();
        particlePositions = new Float32Array(PARTICLE_COUNT * 3);
        colors = new Float32Array(PARTICLE_COUNT * 3);
        targetPositions = new Float32Array(PARTICLE_COUNT * 3);

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            particlePositions[i*3] = (Math.random()-0.5)*50;
            particlePositions[i*3+1] = (Math.random()-0.5)*50;
            particlePositions[i*3+2] = (Math.random()-0.5)*50;
            colors[i*3] = 0; colors[i*3+1] = 0.8; colors[i*3+2] = 1;
            explosionVelocities.push({x:0, y:0, z:0});
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

        const material = new THREE.PointsMaterial({
            size: PARTICLE_SIZE,
            vertexColors: true,
            blending: THREE.AdditiveBlending,
            depthWrite: false,
            transparent: true,
            opacity: 0.8
        });

        particles = new THREE.Points(geometry, material);
        scene.add(particles);
    }

    function calculateSpherePositions() {
        const points = [];
        for (let i=0; i<5000; i++) {
             points.push({x:(Math.random()-0.5)*30, y:(Math.random()-0.5)*30, z:(Math.random()-0.5)*30});
        }
        morphTo(points, 0x00ffff, false);
    }

    // =========================================================
    // 2. AI æ‰‹åŠ¿è¯†åˆ«éƒ¨åˆ†
    // =========================================================
    function initMediaPipe() {
        const videoElement = document.getElementById('video-feed');
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        
        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.6,
            minTrackingConfidence: 0.6
        });

        hands.onResults(onHandsResults);

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });

        cameraUtils.start()
            .then(() => {
                const loader = document.getElementById('loader');
                loader.style.opacity = 0;
                setTimeout(()=>loader.remove(), 500);
            })
            .catch(err => {
                console.error(err);
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™æˆ– HTTPS ç¯å¢ƒ");
            });
    }

    function onHandsResults(results) {
        let detectedGesture = 'none';
        
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            let fingerCount = 0;
            
            // ç®€æ˜“æ‰‹æŒ‡è®¡æ•°é€»è¾‘
            if (lm[8].y < lm[6].y) fingerCount++; // é£ŸæŒ‡
            if (lm[12].y < lm[10].y) fingerCount++; // ä¸­æŒ‡
            if (lm[16].y < lm[14].y) fingerCount++; // æ— åæŒ‡
            if (lm[20].y < lm[18].y) fingerCount++; // å°æŒ‡
            if (Math.abs(lm[4].x - lm[0].x) > Math.abs(lm[3].x - lm[0].x)) fingerCount++; // æ‹‡æŒ‡

            // æ‰‹åŠ¿åˆ†ç±»
            if (fingerCount === 1) detectedGesture = 'one'; 
            else if (fingerCount === 2) detectedGesture = 'two';
            else if (fingerCount === 3) detectedGesture = 'three';
            else if (fingerCount >= 4) detectedGesture = 'open'; // 4æŒ‡æˆ–5æŒ‡éƒ½ç®—å¼ å¼€
            else detectedGesture = 'fist'; // æ¡æ‹³
        }

        // é˜²æŠ–é€»è¾‘
        if (detectedGesture === lastGesture) {
            gestureFrameCount++;
        } else {
            gestureFrameCount = 0;
            lastGesture = detectedGesture;
        }

        if (gestureFrameCount === GESTURE_THRESHOLD) {
            handleGestureAction(detectedGesture);
        }
    }

    function handleGestureAction(gesture) {
        const statusDiv = document.getElementById('hud-status');
        const messageDiv = document.getElementById('message');
        
        switch(gesture) {
            case 'one':
                statusDiv.innerText = "ğŸ‘† è¯†åˆ«ï¼šå•æŒ‡";
                statusDiv.style.color = "#00ffff";
                messageDiv.innerText = "å¼€å¼€å¿ƒå¿ƒ";
                showSakuraRain();
                break;
            case 'two':
                statusDiv.innerText = "âœŒï¸ è¯†åˆ«ï¼šåŒæŒ‡";
                statusDiv.style.color = "#00ffff";
                messageDiv.innerText = "å¥½å¥½çˆ±è‡ªå·±";
                showSakuraRain();
                break;
            case 'three':
                statusDiv.innerText = "ğŸ¤Ÿ è¯†åˆ«ï¼šä¸‰æŒ‡";
                statusDiv.style.color = "#ff80bf";
                messageDiv.innerText = "ä»Šå¤©å¾ˆå“‡å¡";
                showFlowerPetals();
                break;
            case 'open':
                statusDiv.innerText = "ğŸ– è¯†åˆ«ï¼šå¼ æ‰‹";
                statusDiv.style.color = "#ff0044";
                showHeart();
                break;
            case 'fist':
                statusDiv.innerText = "âœŠ è¯†åˆ«ï¼šæ¡æ‹³";
                statusDiv.style.color = "#ffaa00";
                messageDiv.innerText = "æˆ‘çœŸçš„å¾ˆæ£’";
                showExplosion();
                break;
        }

        messageDiv.style.opacity = 1;
        setTimeout(() => {
            messageDiv.style.opacity = 0;
        }, 2000);
    }

    // --- æ‰‹åŠ¿æ•ˆæœ --- 
    function showSakuraRain() {
        // æ¸…é™¤å·²æ˜¾ç¤ºçš„é›¨
        document.querySelectorAll('.petal').forEach(el => el.remove());
        
        for (let i = 0; i < 100; i++) {
            const petal = document.createElement('div');
            petal.classList.add('petal');
            petal.style.width = `${Math.random() * 10 + 5}px`;
            petal.style.height = petal.style.width;
            petal.style.left = `${Math.random() * window.innerWidth}px`;
            petal.style.animationDuration = `${Math.random() * 3 + 2}s`;
            document.body.appendChild(petal);
        }
    }

    function showFlowerPetals() {
        // æ¸…é™¤å·²æ˜¾ç¤ºçš„èŠ±ç“£
        document.querySelectorAll('.flower-petal').forEach(el => el.remove());
        
        for (let i = 0; i < 100; i++) {
            const petal = document.createElement('div');
            petal.classList.add('flower-petal');
            petal.style.width = `${Math.random() * 10 + 5}px`;
            petal.style.height = petal.style.width;
            petal.style.left = `${Math.random() * window.innerWidth}px`;
            petal.style.animationDuration = `${Math.random() * 3 + 2}s`;
            document.body.appendChild(petal);
        }
    }

    function showHeart() {
        // æ˜¾ç¤ºçˆ±å¿ƒåŠ¨ç”»
        const heart = document.createElement('div');
        heart.classList.add('heart');
        heart.style.position = 'absolute';
        heart.style.width = '100px';
        heart.style.height = '100px';
        heart.style.backgroundColor = 'red';
        heart.style.borderRadius = '50%';
        heart.style.left = '50%';
        heart.style.top = '50%';
        document.body.appendChild(heart);
    }

    function showExplosion() {
        // æ˜¾ç¤ºçˆ†ç‚¸æ•ˆæœ
        const explosion = document.createElement('div');
        explosion.style.position = 'absolute';
        explosion.style.left = '50%';
        explosion.style.top = '50%';
        explosion.style.width = '200px';
        explosion.style.height = '200px';
        explosion.style.backgroundColor = 'yellow';
        explosion.style.borderRadius = '50%';
        explosion.style.transform = 'scale(0)';
        document.body.appendChild(explosion);

        explosion.animate([
            { transform: 'scale(0)', opacity: 1 },
            { transform: 'scale(3)', opacity: 0 }
        ], {
            duration: 1000,
            easing: 'ease-out',
            fill: 'forwards'
        });
    }

    // =========================================================
    // 3. åŠ¨ç”»å¾ªç¯ (å«æ™ºèƒ½æ—‹è½¬é€»è¾‘)
    // =========================================================
    function animate() {
        requestAnimationFrame(animate);
        TWEEN.update();
        renderer.render(scene, camera);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
</script>
</body>
</html>
